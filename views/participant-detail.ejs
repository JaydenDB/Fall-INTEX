<!DOCTYPE html>
<html lang="en">
<head>
  <!-- basic head setup -->
  <meta charset="UTF-8" />
  <title>Ella Rises – Participant Detail</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- shared fonts + styles -->
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&family=Playfair+Display:wght@500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <div class="page">

    <!-- global header -->
    <%- include('partials/header') %>

    <section class="section">
      <div class="container" style="max-width: 1000px;">

        <% 
          // small helpers for safe date rendering (avoid crashing if date is invalid)
          function formatDate(d) {
            if (!d) return 'Date unknown';
            try {
              return d.toDateString();
            } catch (e) {
              return String(d);
            }
          }

          function formatDateTime(d) {
            if (!d) return 'Date unknown';
            try {
              return d.toLocaleString('en-US', { dateStyle: 'medium', timeStyle: 'short' });
            } catch (e) {
              return String(d);
            }
          }

          // basic display values for this participant
          const fullName = ((participant.participantfirstname || '') + ' ' + (participant.participantlastname || '')).trim() || '(No name)';
          const initials =
            (participant.participantfirstname ? participant.participantfirstname[0] : '') +
            (participant.participantlastname ? participant.participantlastname[0] : '');
        %>

        <!-- PAGE HEADER -->
        <div class="section-header" style="text-align:left;">
          <p class="section-kicker">Participant</p>
          <h2 class="section-title"><%= fullName %></h2>
          <p class="section-subtitle" style="margin-left:0;">
            Detailed view showing donations, surveys, milestones, and attendance for this participant.
          </p>
        </div>

        <!-- TOP SUMMARY ROW: profile + KPIs -->
        <div style="display:flex; flex-wrap:wrap; gap:1.5rem; align-items:flex-start; margin-bottom:1.5rem;">

          <!-- avatar + basic profile info -->
          <div class="card" style="flex:1 1 260px; display:flex; gap:1rem; align-items:flex-start;">
            <div
              style="
                width:64px;
                height:64px;
                border-radius:50%;
                background:rgba(235,216,255,0.8);
                display:flex;
                align-items:center;
                justify-content:center;
                font-size:1.2rem;
                font-weight:700;
                color:#5b3f7a;
                overflow:hidden;
              "
            >
              <% if (participant.participantphoto) { %>
                <img
                  src="<%= participant.participantphoto %>"
                  alt="<%= fullName %>"
                  style="width:100%; height:100%; object-fit:cover;"
                />
              <% } else { %>
                <%= initials || '?' %>
              <% } %>
            </div>

            <div>
              <!-- name + email -->
              <div style="font-weight:700; font-size:1.1rem; margin-bottom:0.15rem;">
                <%= fullName %>
              </div>
              <div style="font-size:0.88rem; color:var(--text-muted); margin-bottom:0.25rem;">
                <%= participant.participantemail %>
              </div>

              <!-- role + location + school, only shown if present -->
              <div style="font-size:0.8rem; color:var(--text-muted);">
                Role:
                <strong><%= participant.participantrole || 'participant' %></strong>
              </div>

              <% if (participant.participantcity || participant.participantstate) { %>
                <div style="font-size:0.8rem; color:var(--text-muted);">
                  Location:
                  <strong>
                    <%= participant.participantcity || '' %>
                    <%= participant.participantstate ? ', ' + participant.participantstate : '' %>
                  </strong>
                </div>
              <% } %>

              <% if (participant.participantschooloremployer) { %>
                <div style="font-size:0.8rem; color:var(--text-muted);">
                  School / Employer:
                  <strong><%= participant.participantschooloremployer %></strong>
                </div>
              <% } %>

              <% if (participant.participantfieldofinterest) { %>
                <div style="font-size:0.8rem; color:var(--text-muted);">
                  Field of interest:
                  <strong><%= participant.participantfieldofinterest %></strong>
                </div>
              <% } %>
            </div>
          </div>

          <!-- quick KPI cards: donations / attendance / surveys -->
          <div style="flex:2 1 320px; display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:0.9rem;">

            <!-- donation summary -->
            <div class="card">
              <p class="section-kicker" style="margin-bottom:0.2rem;">Donations</p>
              <div style="font-size:1.4rem; font-weight:700;">
                $<%= Number(stats.donations.totalAmount || 0).toLocaleString('en-US', {
                      minimumFractionDigits:2,
                      maximumFractionDigits:2
                    }) %>
              </div>
              <p style="font-size:0.8rem; color:var(--text-muted); margin:0.2rem 0;">
                Across <strong><%= stats.donations.donationCount || 0 %></strong> donation(s).
              </p>
              <% if (stats.donations.donationCount > 0) { %>
                <p style="font-size:0.78rem; color:var(--text-muted); margin:0;">
                  First: <%= formatDate(stats.donations.firstDonation) %><br>
                  Most recent: <%= formatDate(stats.donations.lastDonation) %>
                </p>
              <% } %>
            </div>

            <!-- attendance summary -->
            <div class="card">
              <p class="section-kicker" style="margin-bottom:0.2rem;">Attendance</p>
              <div style="font-size:1.4rem; font-weight:700;">
                <%= stats.registrations.totalRegistrations || 0 %> events
              </div>
              <p style="font-size:0.8rem; color:var(--text-muted); margin:0.2rem 0;">
                Attended: <strong><%= stats.registrations.totalAttended || 0 %></strong><br>
                Attendance rate: <strong><%= stats.registrations.attendanceRate %></strong>
              </p>
            </div>

            <!-- survey summary -->
            <div class="card">
              <p class="section-kicker" style="margin-bottom:0.2rem;">Survey experience</p>
              <div style="font-size:1.4rem; font-weight:700;">
                <%= stats.surveys.avgOverall %> / 5
              </div>
              <p style="font-size:0.8rem; color:var(--text-muted); margin:0.2rem 0;">
                Across <strong><%= stats.surveys.totalSurveys || 0 %></strong> survey(s).
              </p>
              <p style="font-size:0.78rem; color:var(--text-muted); margin:0;">
                Satisfaction: <strong><%= stats.surveys.avgSatisfaction %></strong> / 5<br>
                Usefulness: <strong><%= stats.surveys.avgUsefulness %></strong> / 5
              </p>
            </div>
          </div>
        </div>

        <!-- LOWER GRID: donations, milestones, recent surveys -->
        <div style="display:grid; grid-template-columns: minmax(0, 1.1fr) minmax(0, 1fr); gap:1.2rem; align-items:flex-start;">

          <!-- left column: recent donations + milestones -->
          <div style="display:flex; flex-direction:column; gap:1rem;">

            <!-- recent donations list -->
            <div class="card">
              <h3 style="margin-top:0; margin-bottom:0.4rem;">Recent donations</h3>
              <% if (!stats.donations.recent || stats.donations.recent.length === 0) { %>
                <p style="font-size:0.85rem; color:var(--text-muted); margin:0;">
                  No donations recorded for this participant yet.
                </p>
              <% } else { %>
                <ul style="font-size:0.85rem; color:var(--text-muted); padding-left:1.2rem; margin:0;">
                  <% stats.donations.recent.forEach(d => { %>
                    <li>
                      <%= formatDate(d.donationdate) %> – $
                      <%= Number(d.donationamount || 0).toLocaleString('en-US', {
                            minimumFractionDigits:2,
                            maximumFractionDigits:2
                          }) %>
                    </li>
                  <% }) %>
                </ul>
              <% } %>
            </div>

            <!-- milestones list -->
            <div class="card">
              <h3 style="margin-top:0; margin-bottom:0.4rem;">Milestones</h3>
              <% if (!stats.milestones || stats.milestones.length === 0) { %>
                <p style="font-size:0.85rem; color:var(--text-muted); margin:0;">
                  No milestones logged yet. Use this section to record key achievements (degrees, internships, jobs).
                </p>
              <% } else { %>
                <ul style="font-size:0.85rem; color:var(--text-muted); padding-left:1.2rem; margin:0;">
                  <% stats.milestones.forEach(m => { %>
                    <li>
                      <strong><%= m.milestonetitle %></strong><br>
                      <span style="font-size:0.78rem;">
                        <%= formatDate(m.milestonedate) %>
                      </span>
                    </li>
                  <% }) %>
                </ul>
              <% } %>
            </div>
          </div>

          <!-- right column: recent surveys -->
          <div class="card">
            <h3 style="margin-top:0; margin-bottom:0.4rem;">Recent surveys</h3>
            <% if (!stats.surveys.recent || stats.surveys.recent.length === 0) { %>
              <p style="font-size:0.85rem; color:var(--text-muted); margin:0;">
                No surveys submitted yet for this participant.
              </p>
            <% } else { %>
              <ul style="font-size:0.85rem; color:var(--text-muted); padding-left:1.2rem; margin:0;">
                <% stats.surveys.recent.forEach(s => { %>
                  <li style="margin-bottom:0.45rem;">
                    <strong><%= s.eventname || 'Event' %></strong><br>
                    <span style="font-size:0.78rem;">
                      Attended: <%= formatDateTime(s.eventdatetimestart) %><br>
                      Submitted: <%= formatDateTime(s.surveysubmissiondate) %>
                    </span><br>
                    <span style="font-size:0.78rem;">
                      Satisfaction: <%= s.surveysatisfactionscore || '—' %> / 5 ·
                      Overall: <%= s.surveyoverallscore || '—' %> / 5
                    </span>
                  </li>
                <% }) %>
              </ul>
            <% } %>
          </div>
        </div>
      </div>
    </section>

    <!-- shared footer -->
    <%- include('partials/footer') %>
  </div>
</body>
</html>
