<!DOCTYPE html>
<html lang="en">
<head>
  <!-- basic head setup and shared styles -->
  <meta charset="UTF-8" />
  <title>Ella Rises – Participants</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- fonts and main stylesheet used across the portal -->
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&family=Playfair+Display:wght@500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <div class="page">
    <!-- shared site header (logo + nav + auth state) -->
    <%- include('partials/header') %>

    <section class="section">
      <div class="container">
        <!-- page header: title and quick description -->
        <div class="section-header" style="text-align:left;">
          <img src="/images/ella%20rises%20logo.png" alt="Ella Rises Logo" style="width: 70px; height: 70px; margin-bottom: 1rem;">
          <p class="section-kicker">Participants</p>
          <h2 class="section-title">All Participants</h2>
          <p class="section-subtitle" style="margin-left:0;">
            View participants engaged with Ella Rises events.
            Admins can add, edit, and manage participant records (including profile photos).
          </p>
        </div>

        <!-- top toolbar: add button (if admin) + search + role filter -->
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.8rem; gap:1rem; flex-wrap:wrap;">
          <% if (user && user.role === 'admin') { %>
            <!-- admins can add new participant records -->
            <a href="/participants/new" class="btn btn-primary">+ Add Participant</a>
          <% } %>

          <!-- search and role filter controls sit on the right -->
          <div style="display:flex; gap:0.6rem; align-items:center; flex-wrap:wrap; margin-left:auto;">
            <!-- client-side search (name / email) -->
            <input
              id="participant-search"
              type="text"
              placeholder="Search by name or email..."
              value="<%= (filters && filters.search) || '' %>"
              class="ella-input"
              style="min-width:200px;"
            />

            <!-- server-side role filter (reloads page with query params) -->
            <select
              id="role-filter"
              name="role"
              class="ella-select"
              onchange="window.location='?role=' + encodeURIComponent(this.value) + '&search=' + encodeURIComponent(document.getElementById('participant-search').value)"
            >
              <option value="all" <%= (!filters || filters.role === 'all') ? 'selected' : '' %>>All roles</option>
              <option value="participant" <%= (filters && filters.role === 'participant') ? 'selected' : '' %>>Participants</option>
              <option value="admin" <%= (filters && filters.role === 'admin') ? 'selected' : '' %>>Admins</option>
            </select>
          </div>
        </div>

        <!-- main table card for participant list -->
        <div class="card">
          <table style="width:100%; border-collapse: collapse; font-size:0.88rem;">
            <thead>
              <tr style="text-align:left; border-bottom:1px solid rgba(235,216,255,0.9);">
                <th style="padding:0.5rem;">Participant</th>
                <th style="padding:0.5rem;">Email</th>
                <th style="padding:0.5rem;">Role</th>
                <th style="padding:0.5rem;">City</th>
                <th style="padding:0.5rem;">State</th>
                <% if (user && user.role === 'admin') { %>
                  <!-- actions column only visible to admins -->
                  <th style="padding:0.5rem; text-align:right;">Actions</th>
                <% } %>
              </tr>
            </thead>
            <tbody id="participants-table-body">
              <!-- empty state when no participants are returned -->
              <% if (!participants || participants.length === 0) { %>
                <tr>
                  <td colspan="<%= (user && user.role === 'admin') ? 6 : 5 %>" style="padding:0.8rem; color:var(--text-muted);">
                    No participants found.
                  </td>
                </tr>
              <% } %>

              <!-- render each participant row when we have data -->
              <% if (participants && participants.length > 0) { %>
                <% participants.forEach(p => {
                    // basic name and initials so we can show a small avatar circle
                    const fullName = ((p.participantfirstname || '') + ' ' + (p.participantlastname || '')).trim();
                    const initials = (p.participantfirstname ? p.participantfirstname[0] : '') + (p.participantlastname ? p.participantlastname[0] : '');
                %>
                  <tr
                    class="participant-row"
                    data-name="<%= fullName.toLowerCase() %>"
                    data-email="<%= (p.participantemail || '').toLowerCase() %>"
                    style="border-top:1px solid rgba(245,235,255,0.9);"
                  >
                    <!-- left column: avatar + name + optional field of interest -->
                    <td style="padding:0.5rem; display:flex; align-items:center; gap:0.6rem;">
                      <!-- avatar circle: profile photo if set, otherwise initials -->
                      <div
                        style="
                          width:32px;
                          height:32px;
                          border-radius:50%;
                          background:rgba(235,216,255,0.7);
                          display:flex;
                          align-items:center;
                          justify-content:center;
                          font-size:0.75rem;
                          font-weight:600;
                          color:#5b3f7a;
                          overflow:hidden;
                        "
                      >
                        <% if (p.participantphoto) { %>
                          <img
                            src="<%= p.participantphoto %>"
                            alt="<%= fullName %>"
                            style="width:100%; height:100%; object-fit:cover;"
                          />
                        <% } else { %>
                          <%= initials || '?' %>
                        <% } %>
                      </div>

                      <!-- name and short context text -->
                      <div>
                        <div style="font-weight:600;"><%= fullName || '(No name)' %></div>
                        <% if (p.participantfieldofinterest) { %>
                          <div style="font-size:0.75rem; color:var(--text-muted);">
                            <%= p.participantfieldofinterest %>
                          </div>
                        <% } %>
                      </div>
                    </td>

                    <!-- basic columns: email, role, city/state -->
                    <td style="padding:0.5rem;"><%= p.participantemail %></td>
                    <td style="padding:0.5rem; text-transform:capitalize;"><%= p.participantrole || 'participant' %></td>
                    <td style="padding:0.5rem;"><%= p.participantcity || '—' %></td>
                    <td style="padding:0.5rem;"><%= p.participantstate || '—' %></td>

                    <!-- admin-only actions (view / edit / delete) -->
                    <% if (user && user.role === 'admin') { %>
                      <td style="padding:0.5rem; text-align:right; white-space:nowrap;">
                        <a
                          href="/participants/<%= p.participantid %>"
                          class="btn btn-ghost btn-sm"
                          style="margin-right:0.25rem;"
                        >
                          View
                        </a>
                        <a
                          href="/participants/<%= p.participantid %>/edit"
                          class="btn btn-ghost btn-sm"
                          style="margin-right:0.25rem;"
                        >
                          Edit
                        </a>
                        <form
                          method="POST"
                          action="/participants/<%= p.participantid %>/delete"
                          style="display:inline;"
                          onsubmit="return confirm('Delete this participant? This cannot be undone.');"
                        >
                          <button
                            type="submit"
                            class="btn btn-ghost btn-sm"
                            style="color:#b3261e;"
                          >
                            Delete
                          </button>
                        </form>
                      </td>
                    <% } %>
                  </tr>
                <% }) %>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- shared footer for the site -->
    <%- include('partials/footer') %>
  </div>

  <script>
    // simple in-page search filter (name + email) for the table
    const searchInput = document.getElementById('participant-search');
    const rows = Array.from(document.querySelectorAll('.participant-row'));

    if (searchInput && rows.length > 0) {
      searchInput.addEventListener('input', function () {
        const term = this.value.trim().toLowerCase();

        rows.forEach(row => {
          const name = row.getAttribute('data-name') || '';
          const email = row.getAttribute('data-email') || '';
          const match = !term || name.includes(term) || email.includes(term);
          row.style.display = match ? '' : 'none';
        });
      });
    }
  </script>
</body>
</html>
